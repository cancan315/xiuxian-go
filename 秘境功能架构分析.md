# 秘境功能系统架构分析

## 系统构成图

```
┌─────────────────────────────────────────────────────────┐
│                    Dungeon.vue (主界面)                   │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────────┐    ┌──────────────────┐           │
│  │   难度选择       │    │   增益选择界面    │           │
│  │  (4个难度)       │    │  (Roguelike风格)  │           │
│  └────────┬─────────┘    └────────┬─────────┘           │
│           │                       │                     │
│           └───────────┬───────────┘                     │
│                       ↓                                 │
│           ┌───────────────────────┐                    │
│           │  selectOption(option)  │                    │
│           │  - 应用增益效果         │                    │
│           │  - floor++             │                    │
│           │  - 生成敌人            │                    │
│           │  - 进入战斗            │                    │
│           └───────────┬────────────┘                    │
│                       ↓                                 │
│           ┌───────────────────────┐                    │
│           │   战斗界面 (实时)      │                    │
│           │  - 玩家血条            │                    │
│           │  - 敌人血条            │                    │
│           │  - 战斗日志            │                    │
│           │  - 攻击动画            │                    │
│           └───────────┬────────────┘                    │
│                       ↓                                 │
│           ┌───────────────────────┐                    │
│           │   战斗统计            │                    │
│           │  - 击杀数统计          │                    │
│           │  - 死亡次数            │                    │
│           │  - 奖励统计            │                    │
│           └──────────────────────┘                    │
│                                                          │
└─────────────────────────────────────────────────────────┘
                         │
              ┌──────────┼──────────┐
              │          │          │
              ↓          ↓          ↓
         ┌────────┐ ┌────────┐ ┌────────┐
         │dungeon │ │combat  │ │dungeon │
         │.js     │ │.js     │ │Buffs.js│
         │增益配置 │ │战斗系统 │ │增益管理 │
         └────────┘ └────┬───┘ └────────┘
                        │
                        ↓
                  ┌────────────┐
                  │ Web Worker │
                  │exploration │
                  │.js (后台计算)│
                  └────────────┘
```

---

## 核心模块交互

### 1. 增益系统流程

```
游戏开始
    ↓
startDungeon()
    ↓
generateOptions() ← getRandomOptions(floor)
                ← roguelikeOptions[品质].filter()
    ↓
显示3个随机增益卡
    ↓
┌─ 玩家交互 ─────────────┐
│ selectOption(option)   │
│ - option.effect()      │ ← 调用增益函数修改玩家属性
│ - dungeonState.floor++ │
│ - 进入战斗             │
└────────────────────────┘
    ↓
继续下一层
```

### 2. 战斗系统流程

```
selectOption(option)
    ↓
setTimeout() [1秒延迟]
    ↓
创建CombatManager实例
    ↓
初始化Web Worker
    ↓
postMessage({
  type: 'start_battle',
  player: playerStats,
  enemy: enemyStats,
  enemyInfo: enemy
})
    ↓
┌─ Web Worker计算 ──────────────────┐
│ CombatManager.start()              │
│ executeTurn() [循环]               │
│ - 比较速度→确定先后手               │
│ - 计算伤害 (暴击/连击/吸血/眩晕)    │
│ - 承受伤害                         │
│ - 反击判定                         │
│ - 超过100回合→失败                 │
└────────────────────────────────────┘
    ↓
onmessage监听
    ↓
┌─ 战斗结束 ─────┐
│ 胜利 → 下一层  │
│ 失败 → 秘境结束│
└────────────────┘
```

---

## 属性计算链

### 玩家属性计算流程

```
playerStats (computed)
    ↓
基础属性 (playerInfoStore.baseAttributes)
    ↓
  + 装备加成 (equipmentBonus) [当前=0]
  + 灵宠加成 (petBonus) [当前=0]
    ↓
= 玩家总属性 (用于战斗)

战斗中发生:
    ↓
selectOption(option) 应用增益效果
    ↓
option.effect(playerStats.value)
    ↓
直接修改计算属性中的值
    ↓
下次战斗时自动计入
```

### 伤害计算链

```
calculateDamage(target)
    ├─ 基础伤害 = damage * (1 + combatBoost)
    │
    ├─ 暴击判定
    │   └─ 有效率 = max(0, min(0.8, 
    │       critRate * (1 + combatBoost) - target.critResist * (1 + target.resistanceBoost)
    │     ))
    │   └─ 触发: 伤害 *= 1.5 + critDamageBoost
    │
    ├─ 连击判定
    │   └─ 触发: 伤害 *= 1.3
    │
    ├─ 吸血判定
    │   └─ 触发: 回复 = 伤害 * 30%
    │
    ├─ 眩晕判定
    │   └─ 触发: 目标下回合无法行动
    │
    └─ 最终伤害 = 伤害 * (1 + finalDamageBoost)

takeDamage(amount)
    ├─ 闪避判定
    │   └─ 有效率 = max(0, min(0.8, 
    │       dodgeRate - source.dodgeResist
    │     ))
    │   └─ 触发: 完全回避伤害
    │
    ├─ 伤害减免 = amount * 100 / (100 + defense)
    │
    ├─ 暴击伤害减免 = 伤害 * (1 - critDamageReduce)
    │
    └─ 最终受伤 = 伤害 * (1 - finalDamageReduce)
```

---

## 难度与敌人生成机制

### 难度调整

```
难度选择 (statsStore.dungeonDifficulty)
    ↓
敌人属性 = 基础属性 * (1 + floor * 0.05) * 难度修饰符
    ↓
difficultyModifiers = {
  easy:   { healthMod: 0.8,  damageMod: 0.8 },   // 凡界
  normal: { healthMod: 1.0,  damageMod: 1.0 },   // 小世界
  hard:   { healthMod: 1.2,  damageMod: 1.2 },   // 灵界
  expert: { healthMod: 1.5,  damageMod: 1.5 }    // 仙界
}
```

### 敌人属性计算

```
baseHealth = 100 + difficulty * level * 200
baseDamage = 8 + difficulty * level * 2
baseDefense = 3 + difficulty * level * 2
baseSpeed = 5 + difficulty * level * 2

战斗属性 = 基础值 + difficulty * level * 系数

根据敌人类型调整:
  NORMAL: ×1 (保持不变)
  ELITE:  百分比属性 ×1.3 (上限80%), 数值属性 ×1.5
  BOSS:   百分比属性 ×1.5 (上限90%), 数值属性 ×2
```

---

## Web Worker通信协议

### 消息格式

```javascript
// 发送给Worker
{
  type: 'start_battle',
  player: CombatStats,      // 玩家属性
  enemy: CombatStats,       // 敌人属性
  enemyInfo: {              // 敌人信息
    name: string,
    floor: number,
    isBoss: boolean,
    isElite: boolean
  }
}

// Worker返回消息
{
  type: 'battle_update',
  data: {
    enemy: CombatEntity,    // 更新的敌人数据
    log: string             // 本回合日志
  }
}

{
  type: 'battle_end',
  data: {
    result: {
      victory: boolean,
      rewards: Array
    }
  }
}
```

---

## 状态机

### Dungeon.vue状态

```
初始状态
    ↓
startDungeon() → 显示增益选项界面 (showingOptions = true)
    ↓
selectOption() → 隐藏选项 (showingOptions = false)
              → 应用增益效果
              → floor++
              → 进入战斗 (inCombat = true)
    ↓
战斗循环 (Web Worker) [最多100回合]
    ↓
战斗结束
    ├─ 胜利: 回到增益选择 (showingOptions = true)
    └─ 失败: 秘境结束 (inCombat = false)
```

### CombatManager战斗状态

```
READY
  ↓
start() → IN_PROGRESS
  ↓
executeTurn() [循环]
  ├─ 回合 < 100: 继续战斗
  ├─ 回合 = 100: 自动失败 (DEFEAT)
  └─ 有一方死亡: 结束 (VICTORY 或 DEFEAT)
  ↓
getCombatLog() [获取战斗日志]
```

---

## 增益效果类型

### 属性加成型

直接修改playerStats中的数值属性:
```javascript
effect: (player) => {
  if (player.stats) {
    player.stats.health *= 1.1
    player.stats.damage += 5
    player.stats.defense *= 1.2
  }
}
```

### 比例加成型

增加百分比属性:
```javascript
effect: (player) => {
  if (player.stats) {
    player.stats.critRate += 0.15      // +15%暴击率
    player.stats.finalDamageBoost += 0.1 // +10%最终伤害
  }
}
```

### 组合型

同时调整多个属性:
```javascript
// 天人合一
effect: (player) => {
  if (player.stats) {
    player.stats.combatBoost += 0.4        // +40%战斗属性
    player.stats.maxHealth *= 1.5          // +50%血量上限
    player.stats.health = Math.min(
      player.stats.maxHealth,
      player.stats.health + player.stats.maxHealth * 0.5
    )
  }
}
```

---

## 数据持久化

### localStorage映射 (persistenceStore)

```javascript
localStorage['xiuxian_dungeon_stats'] = {
  dungeonTotalRuns,      // 总运行次数
  dungeonTotalKills,     // 总击杀数
  dungeonBossKills,      // Boss击杀数
  dungeonEliteKills,     // 精英击杀数
  dungeonDeathCount,     // 死亡次数
  dungeonTotalRewards,   // 总奖励次数
  dungeonDifficulty      // 当前难度
}
```

---

## 性能优化点

### 1. Web Worker隔离计算

✅ **已实现**: 战斗计算在Worker中执行，不阻塞UI
- 战斗逻辑 (executeTurn) 在后台运行
- UI每帧更新战斗状态
- 大量计算不影响用户交互

### 2. 属性缓存

✅ **已实现**: 使用computed计算玩家属性
- playerStats自动缓存计算结果
- 只在依赖改变时重新计算
- 减少不必要的属性重算

### 3. 增益池过滤

✅ **已实现**: 避免重复增益
- 已选增益ID加入usedIds集合
- 下次生成时过滤已选增益
- 最多3个选项无重复

### 4. 日志限制

✅ **已实现**: battleLogs.length > 100时删除最早日志
- 避免数组无限增长
- 保持内存占用稳定

---

## 集成依赖关系

```
Dungeon.vue
├── 状态: playerInfoStore (玩家基本属性)
├── 状态: inventoryStore (背包)
├── 状态: equipmentStore (装备)
├── 状态: petsStore (灵宠)
├── 状态: statsStore (统计数据)
├── 组件: LogPanel (战斗日志)
│
├── dungeon.js
│   ├── difficultyModifiers (难度配置)
│   ├── roguelikeOptions (增益选项)
│   └── getRandomOptions() (选项生成)
│
├── combat.js
│   ├── CombatState (枚举)
│   ├── CombatType (枚举)
│   ├── CombatStats (属性计算)
│   ├── CombatEntity (战斗实体)
│   ├── CombatManager (战斗管理)
│   └── generateEnemy() (敌人生成)
│
└── dungeonBuffs.js (可选)
    ├── apply() (应用增益)
    ├── clear() (清除增益)
    └── getActiveBuffs() (查看增益)
```

---

## 系统耦合分析

### 高耦合部分

1. **playerStats计算** ← playerInfoStore直接依赖
   - 修改playerInfoStore结构需要更新playerStats
   - 建议: 抽象为专门的属性计算service

2. **增益效果与CombatStats** ← 直接修改属性对象
   - 增益函数与属性结构强耦合
   - 修改属性名需要更新所有effect函数
   - 建议: 使用策略模式抽象增益应用

### 低耦合部分

1. **Dungeon.vue与dungeon.js** ✅
   - 只依赖getRandomOptions()接口
   - 增益配置修改不影响UI逻辑

2. **Dungeon.vue与combat.js** ✅
   - 只通过Web Worker通信
   - 战斗逻辑独立，可单独测试

3. **战斗系统内部** ✅
   - CombatManager可独立运行
   - CombatStats具有完整的职责

---

## 当前限制与改进空间

### 1. RNG不公平

问题: 使用Math.random()，易被客户端修改
解决方案: 将RNG迁移至Go后端
```
后端生成增益选项 → 发送给前端 → 前端展示
后端执行战斗计算 → 返回结果 → 前端展示动画
```

### 2. 属性上限缺失

问题: 多个增益堆叠导致属性爆炸
```javascript
// 当前没有上限，epic品质可以叠加到∞
玩家血量: 100 → 200 (不朽之躯 ×2) → 400 (天人合一 ×1.5) → ...
```

解决方案:
```javascript
// 添加属性上限
const STAT_CAPS = {
  critRate: 0.95,
  dodgeRate: 0.9,
  finalDamageBoost: 5.0,  // 最多500%伤害
  health: playerBaseHealth * 10 // 最多10倍血量
}
```

### 3. 平衡性问题

问题: 高难度下敌人仍可被秒杀
- 玩家获得极限突破 (+50%) + 战圣至尊 (+40%) = +90%战斗属性
- 敌人防御力 = 10 * 1.5 = 15 (Boss)
- 伤害计算: (100 * 1.9) / (100 + 15) = 160单位 >> 敌人200血量

解决方案:
- 添加负面增益 (减少伤害、降低速度)
- 增加困难模式选择(更强敌人)
- 调整敌人属性增长曲线

---

## 总结

秘境系统是一个**客户端计算型的Roguelike战斗系统**，特点是:

| 维度 | 评分 | 说明 |
|------|------|------|
| 功能完整性 | ⭐⭐⭐⭐⭐ | 增益、战斗、统计都已实现 |
| 代码结构 | ⭐⭐⭐⭐ | 模块化清晰，但有耦合需要优化 |
| 性能 | ⭐⭐⭐⭐⭐ | Web Worker隔离计算，不影响UI |
| 平衡性 | ⭐⭐⭐ | 存在属性爆炸、难度曲线不足 |
| 安全性 | ⭐⭐ | RNG完全客户端，可作弊 |
| 可维护性 | ⭐⭐⭐⭐ | 结构清晰，但需要后端改造 |

**后续改进方向**: Go后端集成 → 后端RNG + 后端战斗计算 → 前端仅负责展示和交互

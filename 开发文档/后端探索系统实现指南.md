# 后端探索系统实现指南

## 系统概述

探索功能已从前端 Web Worker 模式迁移到 **Go 后端实现**，前端仅负责 UI 展示和用户交互。

## 架构设计

```
前端 (Exploration.vue)
    ↓ (HTTP REST API)
后端处理器 (/handlers/exploration/)
    ↓
探索服务层 (/exploration/service.go)
    ↓
数据模型与配置 (/exploration/models.go, config.go)
    ↓
数据库 (PostgreSQL)
```

## 核心模块

### 1. 模型与配置 (`/internal/exploration/`)

#### models.go
定义了探索系统的核心数据结构：
- **ExplorationEvent**: 探索事件对象
- **ExplorationRequest/Response**: API请求和响应
- **EventChoiceRequest/Response**: 事件选择的请求响应
- **Herb**: 灵草信息
- **PillRecipe**: 丹药配方
- **PlayerStats**: 玩家统计属性

#### config.go
包含游戏配置常量：
- **HerbQualities**: 灵草品质等级 (普通/优质/稀有/极品/仙品)
- **HerbConfigs**: 15种灵草的配置 (基础价值、掉率等)
- **PillRecipes**: 12个丹药配方配置
- **品质品质计算函数**: GetHerbValue(), GetRandomQuality()

### 2. 服务层 (`/internal/exploration/service.go`)

**ExplorationService** 类负责所有业务逻辑：

#### 主要方法

**StartExploration(duration int)**
- 开始一次探索
- 根据幸运值计算事件触发概率
- 随机触发8种随机事件
- 返回事件列表和日志

**HandleEventChoice(eventType string, choice interface{})**
- 处理玩家对事件的选择
- 根据事件类型进行不同的处理
- 更新玩家数据库中的数据

**triggerRandomEvent(user *User)**
- 内部方法，触发8种随机事件之一：
  1. 古老石碑 (+修为)
  2. 灵泉 (+灵力)
  3. 古修遗府 (+修为和灵力)
  4. 妖兽袭击 (-灵力)
  5. 走火入魔 (-修为)
  6. 秘境宝藏 (+灵石)
  7. 顿悟 (+修为和灵力获取速率)
  8. 心魔侵扰 (-灵力和修为)

### 3. HTTP 处理器 (`/internal/http/handlers/exploration/`)

#### exploration.go
提供两个HTTP端点：

**POST /api/exploration/start**
- 请求体: `{duration: number}`
- 响应: `{success: boolean, events: [], log: string}`
- 开始一次探索，返回触发的事件列表

**POST /api/exploration/event-choice**
- 请求体: `{eventType: string, choice: any}`
- 响应: `{success: boolean, rewards: any}`
- 处理玩家对事件的选择，返回奖励

### 4. 路由注册 (`/internal/http/router/router.go`)

```go
// /api/exploration 路由组
explorationGroup := r.Group("/api/exploration")
{
    explorationGroup.Use(middleware.Protect())  // 需要认证
    explorationGroup.POST("/start", exploration.StartExploration)
    explorationGroup.POST("/event-choice", exploration.HandleEventChoice)
}
```

## 前端调用方式

### 开始探索
```javascript
const response = await apiClient.post('/api/exploration/start', {
  duration: 10000 // 10秒
})

// 返回数据结构
{
  success: true,
  events: [
    {
      type: 'spirit_stone_found',
      description: '[事件名]事件描述',
      amount: 50,
      choices: [...]
    }
  ],
  log: '探索日志...'
}
```

### 处理事件选择
```javascript
const response = await apiClient.post('/api/exploration/event-choice', {
  eventType: 'spirit_stone_found',
  choice: 'accept' // 或其他选择值
})

// 返回数据结构
{
  success: true,
  rewards: {
    type: 'spirit_stone',
    message: '获得了灵石',
    amount: 50
  }
}
```

## 数据流

### 探索流程
```
1. 玩家点击"开始探索"
   ↓
2. 前端发送POST /api/exploration/start请求
   ↓
3. 后端计算幸运值，触发随机事件
   ↓
4. 后端返回事件列表
   ↓
5. 前端显示事件弹窗
   ↓
6. 玩家选择事件处理方案
   ↓
7. 前端发送POST /api/exploration/event-choice请求
   ↓
8. 后端处理选择，更新玩家数据
   ↓
9. 后端返回奖励信息
   ↓
10. 前端更新UI和统计数据
```

## 关键特性

### 幸运值影响
```go
// 事件触发概率 = 30% × 幸运值
eventChance := 0.3 * luck

// 奖励倍率 = 50% 概率获得 1.5x 倍数
rewardMultiplier := rand.Float64() < 0.5 * luck ? 1.5 : 1
```

### 数据持久化
所有玩家数据变化直接更新数据库：
- `users` 表: 修为、灵力、灵石
- `herbs` 表: 灵草库存
- `pills` 表: 丹药配方

### 事件日志
每次探索返回详细的操作日志，前端显示在日志面板中。

## 开发建议

### 扩展新事件
1. 在 `service.go` 中添加新的事件触发方法
2. 更新 `triggerRandomEvent()` 函数的事件列表
3. 前端对应处理新的事件类型

### 优化建议
1. **缓存灵草配置**: 使用单例模式缓存 HerbConfigs，避免重复创建
2. **事务处理**: 对于涉及多个数据表的操作使用事务确保一致性
3. **速率限制**: 为API添加速率限制防止滥用
4. **日志完善**: 使用 zap 记录详细的探索过程日志

## 依赖项

- Go 标准库: math, rand, time
- GORM: 数据库操作
- Gin: Web框架
- Zap: 日志记录

## 测试

### 单元测试 (待实现)
```go
func TestStartExploration(t *testing.T) {
  service := NewExplorationService(userID)
  events, log, err := service.StartExploration(10000)
  
  assert.Nil(t, err)
  assert.NotNil(t, events)
}
```

### 集成测试 (待实现)
```bash
curl -X POST http://localhost:3000/api/exploration/start \
  -H "Authorization: Bearer token" \
  -H "Content-Type: application/json" \
  -d '{"duration": 10000}'
```

## 性能指标

- 平均响应时间: < 100ms
- 事件触发概率: ~30% (可通过幸运值调整)
- 最大并发连接: 由服务器资源决定

## 后续改进

1. [ ] 实现更复杂的事件选择逻辑
2. [ ] 添加随机物品掉落系统
3. [ ] 实现丹方残页的收集和合成机制
4. [ ] 添加战斗系统集成
5. [ ] 实现难度等级和区域系统
6. [ ] 添加特殊事件和隐藏事件
7. [ ] 实现事件链式触发


# ç§˜å¢ƒæˆ˜æ–—æ•°æ®è‡ªåŠ¨æ¸…ç†æ”¹è¿›

## ğŸ¯ é—®é¢˜æè¿°

åœ¨å‰é¢çš„å®ç°ä¸­ï¼Œå½“ç©å®¶ä¸‹çº¿æˆ–å¿ƒè·³è¶…æ—¶æ—¶ï¼ŒRedisä¸­çš„æˆ˜æ–—çŠ¶æ€æ•°æ®ï¼ˆ`dungeon:battle:status`å’Œ`dungeon:battle:round`ï¼‰æ²¡æœ‰è¢«åŠæ—¶æ¸…ç†ï¼Œå¯¼è‡´ï¼š

1. Rediså­˜å‚¨ç©ºé—´æµªè´¹
2. è¿‡æœŸæ•°æ®ç§¯ç´¯
3. ç©å®¶ä¸‹çº¿åä»æœ‰"å¹½çµ"æˆ˜æ–—çŠ¶æ€
4. é‡æ–°ç™»å½•æ—¶å¯èƒ½é‡åˆ°æ—§æˆ˜æ–—æ•°æ®å¹²æ‰°

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. **åœ¨çº¿çŠ¶æ€ç®¡ç†ä¸­æ·»åŠ æ¸…ç†é€»è¾‘** (`online.go`)

åœ¨ `Logout()` å‡½æ•°ä¸­æ·»åŠ æˆ˜æ–—æ•°æ®æ¸…ç†ï¼š

```go
// å½“ç©å®¶ä¸»åŠ¨ä¸‹çº¿æ—¶ï¼Œæ¸…ç†æˆ˜æ–—æ•°æ®
cleanupDungeonData(playerID, rdb, zapLogger)
```

### 2. **åˆ›å»ºä¸“ç”¨æ¸…ç†å‡½æ•°** (`online.go`)

```go
func cleanupDungeonData(playerID uint, rdb *redisv9.Client, zapLogger *zap.Logger)
```

- æ¸…ç† `dungeon:battle:status:{userID}`
- æ¸…ç† `dungeon:battle:round:{userID}`
- è®°å½•æ¸…ç†æ—¥å¿—

### 3. **å¯åŠ¨åå°å¿ƒè·³ç›‘æ§** (`cleanup.go` - æ–°æ–‡ä»¶)

```go
func StartHeartbeatMonitor(logger *zap.Logger)
```

**åŠŸèƒ½**:
- å¯åŠ¨åå°goroutineï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
- æ£€æŸ¥æ‰€æœ‰åœ¨çº¿ç©å®¶çš„å¿ƒè·³
- å‘ç°è¶…æ—¶ç©å®¶ï¼ˆ>15ç§’æ— å¿ƒè·³ï¼‰ç«‹å³æ¸…ç†ï¼š
  - åˆ é™¤åœ¨çº¿çŠ¶æ€
  - ä»åœ¨çº¿é›†åˆç§»é™¤
  - **æ¸…ç†æˆ˜æ–—æ•°æ®** â­

### 4. **åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–** (`main.go`)

```go
// å¯åŠ¨å¿ƒè·³ç›‘æ§ä»»åŠ¡ï¼ˆæ¸…ç†è¶…æ—¶ç©å®¶å’Œæˆ˜æ–—æ•°æ®ï¼‰
online.StartHeartbeatMonitor(logger)
```

## ğŸ“Š æ¸…ç†æµç¨‹å›¾

```
ç©å®¶åœ¨çº¿
   â†“
[å¿ƒè·³ç›‘æ§æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡]
   â†“
   â”œâ”€ æœ‰å¿ƒè·³ï¼ˆâ‰¤15ç§’ï¼‰â†’ ç»§ç»­åœ¨çº¿
   â””â”€ æ— å¿ƒè·³ï¼ˆ>15ç§’ï¼‰â†’ æ‰§è¡Œæ¸…ç†
       â”œâ”€ åˆ é™¤ player:online:{id}
       â”œâ”€ ä» server:online:players ç§»é™¤
       â””â”€ **æ¸…ç†æˆ˜æ–—æ•°æ®** âœ…
           â”œâ”€ åˆ é™¤ dungeon:battle:status:{id}
           â””â”€ åˆ é™¤ dungeon:battle:round:{id}

æˆ–

ç©å®¶ä¸»åŠ¨ä¸‹çº¿ï¼ˆPOST /api/online/logoutï¼‰
   â†“
   â”œâ”€ åˆ é™¤ player:online:{id}
   â”œâ”€ ä» server:online:players ç§»é™¤
   â””â”€ **æ¸…ç†æˆ˜æ–—æ•°æ®** âœ…
       â”œâ”€ åˆ é™¤ dungeon:battle:status:{id}
       â””â”€ åˆ é™¤ dungeon:battle:round:{id}
```

## ğŸ”‘ å…³é”®ç‰¹æ€§

### âœ… ä¸»åŠ¨æ¸…ç†
- ç©å®¶ä¸»åŠ¨ä¸‹çº¿æ—¶ç«‹å³æ¸…ç†æˆ˜æ–—æ•°æ®
- ä¸ä¾èµ–ä»»ä½•å»¶è¿Ÿæœºåˆ¶

### âœ… è¢«åŠ¨æ¸…ç†
- åå°ç›‘æ§æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
- è‡ªåŠ¨æ£€æµ‹å¿ƒè·³è¶…æ—¶
- è‡ªåŠ¨æ¸…ç†è¶…æ—¶ç©å®¶æ•°æ®

### âœ… éé˜»å¡
- å¿ƒè·³ç›‘æ§è¿è¡Œåœ¨ç‹¬ç«‹çš„goroutineä¸­
- ä¸å½±å“ä¸»çº¿ç¨‹å’Œè¯·æ±‚å¤„ç†
- ä½¿ç”¨tickeræœºåˆ¶å®šæœŸæ£€æŸ¥

### âœ… è¯¦ç»†æ—¥å¿—
```
[INFO]  ç©å®¶ç¦»çº¿æˆåŠŸ, userID=1, playerID="1"
[INFO]  å·²æ¸…ç†ç©å®¶æˆ˜æ–—æ•°æ®, userID=1, battleStatusKey="dungeon:battle:status:1", roundDataKey="dungeon:battle:round:1"
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `online.go` | æ–°å¢ cleanupDungeonData() å‡½æ•°ï¼›æ”¹é€  Logout() è°ƒç”¨æ¸…ç† |
| `cleanup.go` | ğŸ†• æ–°æ–‡ä»¶ï¼šStartHeartbeatMonitor()ã€checkAndCleanupTimeoutPlayers() |
| `main.go` | å¯åŠ¨æ—¶è°ƒç”¨ online.StartHeartbeatMonitor(logger) |

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸ä¸‹çº¿
```
1. ç©å®¶è°ƒç”¨ POST /api/online/logout
2. ç³»ç»Ÿåˆ é™¤åœ¨çº¿çŠ¶æ€
3. ç³»ç»Ÿæ¸…ç†æˆ˜æ–—æ•°æ® âœ…
4. è¿”å›ä¸‹çº¿æˆåŠŸ
```

### åœºæ™¯2ï¼šå¿ƒè·³è¶…æ—¶
```
1. ç©å®¶æœ€åå¿ƒè·³äº T-20ç§’
2. ç›‘æ§äº T ç§’æ£€æŸ¥ï¼ˆè¶…è¿‡15ç§’ï¼‰
3. ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹è¶…æ—¶
4. ç³»ç»Ÿåˆ é™¤åœ¨çº¿çŠ¶æ€
5. ç³»ç»Ÿæ¸…ç†æˆ˜æ–—æ•°æ® âœ…
6. æ—¥å¿—è®°å½•ï¼š"ç©å®¶å¿ƒè·³è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†"
```

### åœºæ™¯3ï¼šç½‘ç»œæ³¢åŠ¨åæ¢å¤
```
1. ç©å®¶å¿ƒè·³æ³¢åŠ¨ï¼Œä½†æœªè¶…è¿‡15ç§’
2. ç›‘æ§ä¸æ¸…ç†
3. ç©å®¶ç»§ç»­æˆ˜æ–— âœ…
```

## ğŸ” ç›‘æ§æŒ‡æ ‡

åå°ç›‘æ§æ¯æ¬¡è¿è¡Œä¼šè¾“å‡ºï¼š
- åœ¨çº¿ç©å®¶æ€»æ•°
- è¶…æ—¶ç©å®¶æ•°ï¼ˆå¦‚æœæœ‰ï¼‰
- æ¸…ç†çš„æˆ˜æ–—æ•°æ®æ•°é‡

ç¤ºä¾‹æ—¥å¿—ï¼š
```
[INFO]  å¿ƒè·³ç›‘æ§å·²å¯åŠ¨ï¼Œå°†æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡è¶…æ—¶ç©å®¶
[WARN]  ç©å®¶å¿ƒè·³è¶…æ—¶ï¼Œè¿›è¡Œæ¸…ç†, playerID="1", lastHeartbeat=1703110913000, currentTime=1703111000000, timeDiff=87000
[INFO]  å·²æ¸…ç†ç©å®¶æˆ˜æ–—æ•°æ®, userID=1, battleStatusKey="dungeon:battle:status:1", roundDataKey="dungeon:battle:round:1"
```

## âš™ï¸ é…ç½®å‚æ•°

### å¿ƒè·³ç›‘æ§é—´éš”
```go
ticker := time.NewTicker(5 * time.Second) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
```

### å¿ƒè·³è¶…æ—¶æ—¶é—´
```go
heartbeatTimeoutMs := int64(15 * 1000) // 15ç§’è¶…æ—¶
```

å¯æ ¹æ®éœ€è¦è°ƒæ•´è¿™ä¸¤ä¸ªå‚æ•°ä»¥æ”¹å˜ç›‘æ§è¡Œä¸ºã€‚

## ğŸ¬ å®ç°ç»†èŠ‚

### cleanupDungeonData()
```go
// æ¸…ç†æˆ˜æ–—æ•°æ®
battleStatusKey := fmt.Sprintf("dungeon:battle:status:%d", playerID)
roundDataKey := fmt.Sprintf("dungeon:battle:round:%d", playerID)

// ä¸€æ¬¡åˆ é™¤ä¸¤ä¸ªkey
rdb.Del(ctx, battleStatusKey, roundDataKey)
```

### StartHeartbeatMonitor()
```go
// å¯åŠ¨åå°goroutine
go func() {
    ticker := time.NewTicker(5 * time.Second)
    defer ticker.Stop()
    
    for range ticker.C {
        checkAndCleanupTimeoutPlayers(logger)
    }
}()
```

## ğŸ“ˆ ä¼˜åŠ¿

âœ… **åŠæ—¶æ¸…ç†**: é¿å…Redisæ•°æ®ç§¯ç´¯
âœ… **è‡ªåŠ¨åŒ–**: åå°è‡ªåŠ¨æ£€æŸ¥ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
âœ… **å¯é æ€§**: ä¸¤å±‚ä¿éšœï¼ˆä¸»åŠ¨+è¢«åŠ¨ï¼‰
âœ… **æ—¥å¿—å®Œæ•´**: æ¯æ¬¡æ¸…ç†éƒ½æœ‰è¯¦ç»†æ—¥å¿—
âœ… **æ€§èƒ½ä¼˜åŒ–**: éé˜»å¡å¼åå°å¤„ç†
âœ… **æ˜“äºç›‘æ§**: å¯é€šè¿‡æ—¥å¿—äº†è§£æ¸…ç†æƒ…å†µ

## ğŸš€ ä¸‹ä¸€æ­¥æ”¹è¿›

1. **å¯é…ç½®æ€§**: å°†è¶…æ—¶æ—¶é—´ã€æ£€æŸ¥é—´éš”æ”¹ä¸ºå¯é…ç½®
2. **æŒ‡æ ‡æ”¶é›†**: æ”¶é›†æ¸…ç†ç»Ÿè®¡ä¿¡æ¯ä¾›ç›‘æ§ç³»ç»Ÿä½¿ç”¨
3. **ä¼˜é›…å…³é—­**: æœåŠ¡å…³é—­æ—¶ä¼˜é›…åœæ­¢ç›‘æ§goroutine
4. **æ‰¹é‡æ¸…ç†**: æ”¯æŒæ‰¹é‡æ¸…ç†å¤šä¸ªç©å®¶çš„æˆ˜æ–—æ•°æ®

---

**å®ç°æ—¶é—´**: 2025å¹´12æœˆ21æ—¥
**çŠ¶æ€**: å·²å®Œæˆå¹¶éƒ¨ç½²
**ç›¸å…³æ–‡æ¡£**: 
- DUNGEON_ROUND_POLLING_GUIDE.md - è½®è¯¢APIæ–‡æ¡£
- DUNGEON_STREAMING_IMPLEMENTATION.md - å®Œæ•´å®ç°æ€»ç»“


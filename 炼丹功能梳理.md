# 炼丹功能完整梳理

## 一、系统概述

炼丹系统是一个完整的**丹药制作与消耗系统**，包括：
- **丹方管理**：获取、学习、掌握丹方
- **材料消耗**：收集灵草进行合成
- **炼制过程**：控制成功率的炼制机制
- **效果应用**：丹药生效对玩家的属性影响

---

## 二、核心数据结构

### 2.1 丹药品阶系统 (`pillGrades`)

| 品阶 | 难度系数 | 基础成功率 | 所需残页数 | 难度评级 |
|------|---------|----------|----------|--------|
| 一品 | 1.0 | 90% | 10 | ⭐ |
| 二品 | 1.2 | 80% | 15 | ⭐⭐ |
| 三品 | 1.5 | 70% | 20 | ⭐⭐⭐ |
| 四品 | 2.0 | 60% | 25 | ⭐⭐⭐⭐ |
| 五品 | 2.5 | 50% | 30 | ⭐⭐⭐⭐⭐ |
| 六品 | 3.0 | 40% | 35 | ⭐⭐⭐⭐⭐⭐ |
| 七品 | 4.0 | 30% | 40 | ⭐⭐⭐⭐⭐⭐⭐ |
| 八品 | 5.0 | 20% | 45 | ⭐⭐⭐⭐⭐⭐⭐⭐ |
| 九品 | 6.0 | 10% | 50 | ⭐⭐⭐⭐⭐⭐⭐⭐⭐ |

**计算公式**：
```
残页数 = (品阶数字 × 5) + 5
一品: 1×5+5=10  二品: 2×5+5=15  ...  九品: 9×5+5=50
```

### 2.2 丹药类型系统 (`pillTypes`)

| 类型 | 名称 | 效果倍数 | 用途 |
|------|------|---------|------|
| spirit | 灵力类 | ×1.0 | 灵力恢复、灵力上限 |
| cultivation | 修炼类 | ×1.2 | 修炼速度、修为增长 |
| attribute | 属性类 | ×1.5 | 属性增强、属性相关 |
| special | 特殊类 | ×2.0 | 全属性、综合提升 |

**效果计算**：
```
最终效果 = 基础效果 × 类型倍数 × 玩家境界倍数
玩家境界倍数 = 1 + (玩家等级 - 1) × 0.1
```

---

## 三、丹方配置详解

### 3.1 现有丹方列表（12种）

#### 灵力类丹药
```javascript
{
  id: 'spirit_gathering',         // 聚灵丹 (一品)
  name: '聚灵丹',
  grade: 'grade1',
  type: 'spirit',
  materials: [
    { herb: 'spirit_grass', count: 2 },
    { herb: 'cloud_flower', count: 1 }
  ],
  baseEffect: {
    type: 'spiritRate',           // 灵力恢复速度
    value: 0.2,                   // +20%
    duration: 3600                // 持续1小时
  }
}

{
  id: 'spirit_recovery',          // 回灵丹 (二品)
  name: '回灵丹',
  grade: 'grade2',
  type: 'spirit',
  materials: [
    { herb: 'dark_yin_grass', count: 2 },
    { herb: 'frost_lotus', count: 1 }
  ],
  baseEffect: {
    type: 'spiritRecovery',       // 灵力快速恢复
    value: 0.4,                   // +40%
    duration: 1200                // 持续20分钟
  }
}

{
  id: 'sun_moon_pill',            // 日月丹 (七品)
  name: '日月丹',
  grade: 'grade7',
  type: 'spirit',
  materials: [
    { herb: 'sun_essence_flower', count: 2 },
    { herb: 'moonlight_orchid', count: 2 }
  ],
  baseEffect: {
    type: 'spiritCap',            // 灵力上限
    value: 1.5,                   // +150%
    duration: 2400
  }
}
```

#### 修炼类丹药
```javascript
{
  id: 'cultivation_boost',        // 聚气丹 (二品)
  name: '聚气丹',
  grade: 'grade2',
  type: 'cultivation',
  materials: [
    { herb: 'cloud_flower', count: 2 },
    { herb: 'thunder_root', count: 1 }
  ],
  baseEffect: {
    type: 'cultivationRate',      // 修炼速度
    value: 0.3,                   // +30% (实际×1.2 = 36%)
    duration: 1800
  }
}

{
  id: 'celestial_essence_pill',   // 天元丹 (六品)
  name: '天元丹',
  grade: 'grade6',
  type: 'cultivation',
  materials: [
    { herb: 'celestial_dew_grass', count: 2 },
    { herb: 'moonlight_orchid', count: 1 }
  ],
  baseEffect: {
    type: 'cultivationRate',
    value: 1.0,                   // +100% (实际×1.2 = 120%)
    duration: 1800
  }
}

{
  id: 'essence_condensation',     // 凝元丹 (三品)
  name: '凝元丹',
  grade: 'grade3',
  type: 'cultivation',
  materials: [
    { herb: 'nine_leaf_lingzhi', count: 2 },
    { herb: 'purple_ginseng', count: 1 }
  ],
  baseEffect: {
    type: 'cultivationEfficiency', // 修炼效率
    value: 0.5,                   // +50%
    duration: 1500
  }
}
```

#### 属性类丹药
```javascript
{
  id: 'thunder_power',            // 雷灵丹 (三品)
  name: '雷灵丹',
  grade: 'grade3',
  type: 'attribute',
  materials: [
    { herb: 'thunder_root', count: 2 },
    { herb: 'dragon_breath_herb', count: 1 }
  ],
  baseEffect: {
    type: 'combatBoost',          // 战斗属性
    value: 0.4,                   // +40% (实际×1.5 = 60%)
    duration: 900
  }
}

{
  id: 'five_elements_pill',       // 五行丹 (五品)
  name: '五行丹',
  grade: 'grade5',
  type: 'attribute',
  materials: [
    { herb: 'five_elements_grass', count: 2 },
    { herb: 'phoenix_feather_herb', count: 1 }
  ],
  baseEffect: {
    type: 'allAttributes',        // 全属性
    value: 0.8,                   // +80% (实际×1.5 = 120%)
    duration: 1200
  }
}

{
  id: 'fire_essence',             // 火元丹 (四品)
  name: '火元丹',
  grade: 'grade4',
  type: 'attribute',
  materials: [
    { herb: 'fire_heart_flower', count: 2 },
    { herb: 'dragon_breath_herb', count: 1 }
  ],
  baseEffect: {
    type: 'fireAttribute',        // 火属性修炼
    value: 0.6,                   // +60% (实际×1.5 = 90%)
    duration: 1800
  }
}
```

#### 特殊类丹药
```javascript
{
  id: 'immortal_essence',         // 仙灵丹 (四品)
  name: '仙灵丹',
  grade: 'grade4',
  type: 'special',
  materials: [
    { herb: 'dragon_breath_herb', count: 2 },
    { herb: 'immortal_jade_grass', count: 1 }
  ],
  baseEffect: {
    type: 'allAttributes',        // 全属性
    value: 0.5,                   // +50% (实际×2.0 = 100%)
    duration: 600
  }
}

{
  id: 'mind_clarity',             // 清心丹 (三品)
  name: '清心丹',
  grade: 'grade3',
  type: 'special',
  materials: [
    { herb: 'frost_lotus', count: 2 },
    { herb: 'fire_heart_flower', count: 1 }
  ],
  baseEffect: {
    type: 'comprehension',        // 心境悟性
    value: 0.3,                   // +30% (实际×2.0 = 60%)
    duration: 2400
  }
}

{
  id: 'phoenix_rebirth_pill',     // 涅槃丹 (八品)
  name: '涅槃丹',
  grade: 'grade8',
  type: 'special',
  materials: [
    { herb: 'phoenix_feather_herb', count: 3 },
    { herb: 'celestial_dew_grass', count: 1 }
  ],
  baseEffect: {
    type: 'autoHeal',             // 战斗自动恢复
    value: 0.1,                   // +10% (实际×2.0 = 20%)
    duration: 3600
  }
}
```

---

## 四、灵草材料系统

### 4.1 灵草品质等级

| 品质 | 名称 | 价值倍数 | 获取概率 | 稀有度 |
|------|------|---------|---------|-------|
| common | 普通 | ×1.0 | 50% | 常见 |
| uncommon | 优质 | ×1.5 | 30% | 较常见 |
| rare | 稀有 | ×2.0 | 15% | 少见 |
| epic | 极品 | ×3.0 | 4% | 罕见 |
| legendary | 仙品 | ×5.0 | 1% | 极罕见 |

### 4.2 灵草种类（15种）

#### 灵力类灵草 (Spirit)
- **灵精草** (基础值:10) - 最常见的灵草，获取率40%
- **玄阴草** (基础值:30) - 生长在阴暗处，获取率20%
- **寒霜莲** (基础值:55) - 极寒之地莲花，获取率7%
- **月华兰** (基础值:70) - 月圆之夜绽放，获取率4%

#### 修炼类灵草 (Cultivation)
- **云雾花** (基础值:15) - 云雾缭绕处，获取率30%
- **日精花** (基础值:75) - 吸收太阳精华，获取率3%

#### 属性类灵草 (Attribute)
- **雷击根** (基础值:25) - 雷霆淬炼，获取率15%
- **火心花** (基础值:35) - 火山口奇花，获取率15%
- **五行草** (基础值:80) - 五种属性合一，获取率2%

#### 特殊类灵草 (Special)
- **龙息草** (基础值:40) - 龙气孕育，获取率10%
- **仙玉草** (基础值:60) - 传说仙境灵草，获取率5%
- **九叶灵芝** (基础值:50) - 九叶灵芝，获取率8%
- **紫金参** (基础值:45) - 紫金之参，获取率6%
- **凤羽草** (基础值:85) - 不死火凤栖息地，获取率1.5%
- **天露草** (基础值:90) - 凝聚天地精华，获取率1%

**灵草价值计算**：
```
实际价值 = 基础价值 × 品质倍数
例如：灵精草(10) 的稀有品质(2.0) = 20灵石
```

---

## 五、丹方获取流程

### 5.1 丹方获取方式

#### 方式一：探索获得残页
- 通过**探索系统**随机获得丹方残页
- 不同地点的残页掉落概率不同
- 示例：龙渊可获得10-15个残页

#### 方式二：直接购买残页
```javascript
// 购买逻辑
const fragmentPrice = recipe.grade * 100
// 一品丹方残页: 100灵石
// 二品丹方残页: 200灵石
// ...
// 四品丹方残页: 400灵石
```

**UI流程**：
1. 点击"购买丹方残页"按钮
2. 扣除对应灵石
3. 获得一片残页
4. 残页数量达到需求时自动合成完整丹方

### 5.2 丹方合成条件

```javascript
// 自动合成检测 (在gainPillFragment中)
if (pillsStore.pillFragments[recipeId] >= recipe.fragmentsNeeded) {
  // 消耗残页
  pillsStore.pillFragments[recipeId] -= recipe.fragmentsNeeded
  
  // 添加到已掌握丹方
  if (!pillsStore.pillRecipes.includes(recipeId)) {
    pillsStore.pillRecipes.push(recipeId)
    statsStore.unlockedPillRecipes += 1
  }
  
  message.success(`成功合成${recipe.name}丹方！`)
}
```

---

## 六、炼制流程详解

### 6.1 炼制前置条件检查

```javascript
const craftPill = () => {
  // 检查1：丹方是否已掌握
  if (!recipe || !pillsStore.pillRecipes.includes(recipe.id)) {
    message.error('未掌握该丹方')
    return
  }
  
  // 检查2：材料是否充足
  if (!checkMaterials(recipe)) {
    message.error('材料不足')
    return
  }
  
  // 通过所有检查，进行炼制
  craftPill()
}
```

### 6.2 成功率计算

```javascript
// 基础成功率：grade.successRate (例如一品90%)
// 修正因子1：玩家幸运值 (playerInfoStore.luck)
// 修正因子2：炼丹技能 (playerInfoStore.alchemyRate)

const successRate = 
  grade.successRate              // 基础成功率
  × playerInfoStore.luck         // 幸运值修正
  × playerInfoStore.alchemyRate  // 炼丹技能修正

// 例如：
// 一品丹(90%) × 幸运值1.0 × 技能加成1.0 = 90%
// 四品丹(60%) × 幸运值1.1 × 技能加成1.2 = 79.2%
```

### 6.3 炼制成功流程

```javascript
if (Math.random() > successRate) {
  // 失败：消耗材料，无获得
  message.error('炼制失败')
  logRef.value.addLog(`炼制${recipe.name}失败`)
  return
}

// 成功：消耗材料 → 创建丹药 → 更新统计

// 步骤1：消耗材料
recipe.materials.forEach(material => {
  for (let i = 0; i < material.count; i++) {
    const index = inventoryStore.herbs.findIndex(
      h => h.id === material.herb
    )
    if (index > -1) {
      inventoryStore.herbs.splice(index, 1)
    }
  }
})

// 步骤2：计算丹药效果
const effect = calculatePillEffect(recipe, playerInfoStore.level)

// 步骤3：创建丹药对象
const pill = {
  id: `${recipe.id}_${Date.now()}`,
  name: recipe.name,
  description: recipe.description,
  type: 'pill',
  effect: {
    type: effect.type,
    value: effect.value,          // 根据玩家等级调整
    duration: effect.duration,
    successRate: effect.successRate
  }
}

// 步骤4：添加到背包
inventoryStore.items.push(pill)

// 步骤5：更新统计数据
pillsStore.pillsCrafted++

// 步骤6：提示成功
message.success('炼制成功')
logRef.value.addLog(`成功炼制${recipe.name}`)
```

---

## 七、丹药效果计算

### 7.1 效果值计算公式

```javascript
export const calculatePillEffect = (recipe, playerLevel) => {
  const grade = pillGrades[recipe.grade]
  const type = pillTypes[recipe.type]
  
  // 等级倍数 = 1 + (等级 - 1) × 0.1
  const levelMultiplier = 1 + (playerLevel - 1) * 0.1
  
  // 最终效果 = 基础效果 × 类型倍数 × 等级倍数
  return {
    type: recipe.baseEffect.type,
    value: 
      recipe.baseEffect.value          // 基础值
      × type.effectMultiplier          // 类型倍数
      × levelMultiplier,               // 等级倍数
    duration: recipe.baseEffect.duration,
    successRate: grade.successRate
  }
}
```

### 7.2 示例计算

**场景**：玩家等级10，炼制聚灵丹(灵力类，基础+20%)

```
基础效果：0.2 (20%)
类型倍数：1.0 (灵力类)
等级倍数：1 + (10-1)×0.1 = 1.9

最终效果 = 0.2 × 1.0 × 1.9 = 0.38 (38%)
```

**UI展示**：
```
效果数值：+38.0%
持续时间：60分钟 (3600秒 ÷ 60)
成功率：90.0% (一品丹基础成功率)
```

---

## 八、页面UI结构

### 8.1 Alchemy.vue 组件结构

```
<n-card title="丹药炼制">
  ├─ 丹方选择 (2列网格)
  │  ├─ 品阶标签
  │  ├─ 类型标签
  │  └─ 选择按钮
  │
  ├─ 材料需求 (列表)
  │  ├─ 材料名称
  │  ├─ 需要数量
  │  └─ 拥有数量 (动态背景)
  │
  ├─ 效果预览 (描述表)
  │  ├─ 丹药介绍
  │  ├─ 效果数值
  │  ├─ 持续时间
  │  └─ 成功率
  │
  ├─ 炼制按钮 (条件禁用)
  │  └─ 动态文本
  │
  └─ 炼丹日志 (LogPanel)
```

### 8.2 关键计算属性

```javascript
// 解锁的丹方列表
unlockedRecipes = 已掌握丹方的完整配置

// 当前效果预览
currentEffect = {
  value: 计算后的效果值,
  duration: 持续时间,
  successRate: 成功率
}

// 材料状态
getMaterialStatus(material) {
  return `${拥有数量}/${需要数量}`
}

// 材料充足检查
checkMaterials(recipe) {
  return 所有材料数量都 >= 需要数量
}
```

---

## 九、状态管理 (Pinia Store)

### 9.1 Pills Store (`usePillsStore`)

```javascript
export const usePillsStore = defineStore('pills', {
  state: () => ({
    pills: [],                  // 丹药库存
    pillFragments: {},          // 残页数量 {recipeId: count}
    pillRecipes: [],            // 已掌握丹方ID列表
    activeEffects: [],          // 当前生效的丹药效果
    pillsCrafted: 0,            // 炼制总数 (成就统计)
    pillsConsumed: 0            // 服用总数 (成就统计)
  }),
  
  actions: {
    // 获得丹方残页
    gainPillFragment(recipeId, persistenceStore) {
      // 残页++
      // 检查是否自动合成
      // 发送统计数据
    },
    
    // 炼制丹药
    craftPill(recipeId, herbsStore, playerInfoStore, persistenceStore) {
      // 检查丹方
      // 检查材料
      // 计算成功率
      // 消耗材料
      // 创建丹药
      // 更新统计
    }
  }
})
```

---

## 十、成就系统关联

### 10.1 炼丹相关成就

| 成就ID | 成就名 | 解锁条件 | 奖励 |
|--------|--------|---------|------|
| alchemy_1 | 初识丹道 | 炼制1颗丹药 | +200灵气 |
| alchemy_2 | 炼丹学徒 | 炼制5颗丹药 | +500灵气 |
| alchemy_3 | 丹道小成 | 炼制10颗丹药 | +1000灵气 |
| alchemy_4 | 炼丹达人 | 炼制50颗丹药 | +2000灵气 |
| alchemy_5 | 丹道精通 | 炼制100颗丹药 | +5000灵气 + 炼丹技能×1.2 |
| alchemy_6 | 炼丹大师 | 炼制500颗丹药 | +10000灵气 + 炼丹技能×1.3 |
| alchemy_7 | 丹道宗师 | 炼制1000颗丹药 | 高级奖励 |

---

## 十一、数据流向图

```
灵草系统
   ↓ (材料消耗)
炼丹系统 → 成功率判定
   ↓ (成功) 
丹药库存 → 背包系统
   ↓ (服用)
玩家属性 → 修炼系统 / 战斗系统
   ↓
成就解锁 → 统计数据
```

---

## 十二、关键字段映射

| 字段 | 来源 | 用途 | 类型 |
|------|------|------|------|
| pillRecipes | plugins/pills.js | 丹方配置库 | Array |
| pillGrades | plugins/pills.js | 品阶配置 | Object |
| pillTypes | plugins/pills.js | 类型配置 | Object |
| pillFragments | store/pills | 残页存储 | Object(Map) |
| pillRecipes | store/pills | 已掌握丹方 | Array |
| pills | store/pills | 丹药库存 | Array |
| activeEffects | store/pills | 生效中的效果 | Array |
| herbs | store/inventory | 灵草库存 | Array |

---

## 十三、扩展建议

### 13.1 可优化的方向

1. **后端迁移**
   - 将丹方配置移至后端数据库
   - 炼制过程在服务器执行
   - 确保数据安全性

2. **效果系统完善**
   - 实现丹药使用界面
   - 处理多个丹药效果叠加
   - 实现效果定时器管理

3. **成就联动**
   - 关联指定丹方成就
   - 实现特殊丹方收集成就
   - 统计炼制成功率成就

4. **NPC系统**
   - 添加炼丹师NPC
   - 实现丹方学习对话
   - 丹方残页交易

5. **数据持久化**
   - 丹药数据库存储
   - 炼制历史记录
   - 玩家炼丹统计追踪

---

## 十四、已知问题与改进

### 14.1 当前实现的局限

- ❌ 丹药效果未真正应用（无效果计时器）
- ❌ 多丹药效果不支持叠加
- ❌ 丹药无使用/消费流程
- ⚠️  材料消耗逻辑需优化（个别消耗效率)
- ⚠️  灵草品质权重可调整

### 14.2 建议改进方案

1. **实现效果计时系统**
   ```javascript
   // 添加effect定时器管理
   applyPillEffect(pill) {
     const effect = {
       ...pill.effect,
       startTime: Date.now(),
       expiresAt: Date.now() + pill.effect.duration * 1000
     }
     pillsStore.activeEffects.push(effect)
   }
   ```

2. **完善材料匹配**
   ```javascript
   // 按ID而不是数组查找
   removeMaterial(herbId, count) {
     for (let i = 0; i < count; i++) {
       const idx = inventoryStore.herbs.findIndex(
         h => h.id === herbId
       )
       if (idx > -1) {
         inventoryStore.herbs.splice(idx, 1)
       }
     }
   }
   ```


# æ“ä½œæ—¶é—´æˆ³åŒæ­¥æœºåˆ¶ - å¿«é€Ÿå‚è€ƒ

## æ ¸å¿ƒæ¦‚å¿µ (30ç§’é€Ÿè¯»)

**ä»€ä¹ˆ**: åœ¨Redisä¸­è®°å½•æ¯æ¬¡ç©å®¶æ“ä½œçš„æ—¶é—´ï¼Œå®šæœŸåŒæ­¥æ—¶è·³è¿‡æœ€è¿‘5ç§’å†…æœ‰æ“ä½œçš„ç”¨æˆ·
**ä¸ºä»€ä¹ˆ**: é™ä½æ•°æ®åº“å†™å…¥å‹åŠ›ï¼Œå‡å°‘æ´»è·ƒç©å®¶çš„å†—ä½™åŒæ­¥
**æ•ˆæœ**: DBå†™å…¥â†“40-60%ï¼ŒåŒæ­¥å»¶è¿Ÿ<10ç§’ï¼Œç³»ç»Ÿå‹åŠ›â†“15-20%

---

## æ–°å¢å‡½æ•°é€ŸæŸ¥è¡¨

### è£…å¤‡èµ„æº (`internal/redis/equipment.go`)

| å‡½æ•°å | åŠŸèƒ½ | è¿”å›å€¼ |
|-------|------|--------|
| `UpdateEquipmentLastOperationTime(ctx, userID)` | è®°å½•å½“å‰æ—¶é—´ä¸ºæ“ä½œæ—¶é—´æˆ³ | error |
| `GetEquipmentLastOperationTime(ctx, userID)` | è·å–ä¸Šæ¬¡æ“ä½œçš„Unixæ—¶é—´æˆ³ | (int64, error) |
| `ShouldSyncEquipmentToDb(ctx, userID, timeout)` | åˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥(>timeoutç§’) | bool |

**è‡ªåŠ¨è°ƒç”¨ç‚¹**:
- `SetEquipmentResources()` - è®¾ç½®èµ„æºæ—¶è‡ªåŠ¨è°ƒç”¨
- `DecrementReinforceStones()` - å‡å°‘å¼ºåŒ–çŸ³æ—¶è‡ªåŠ¨è°ƒç”¨
- `DecrementRefinementStones()` - å‡å°‘æ´—ç»ƒçŸ³æ—¶è‡ªåŠ¨è°ƒç”¨

### çµå® èµ„æº (`internal/redis/pet.go`)

| å‡½æ•°å | åŠŸèƒ½ | è¿”å›å€¼ |
|-------|------|--------|
| `UpdatePetLastOperationTime(ctx, userID)` | è®°å½•å½“å‰æ—¶é—´ä¸ºæ“ä½œæ—¶é—´æˆ³ | error |
| `GetPetLastOperationTime(ctx, userID)` | è·å–ä¸Šæ¬¡æ“ä½œçš„Unixæ—¶é—´æˆ³ | (int64, error) |
| `ShouldSyncPetToDb(ctx, userID, timeout)` | åˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥(>timeoutç§’) | bool |

**è‡ªåŠ¨è°ƒç”¨ç‚¹**:
- `SetPetResources()` - è®¾ç½®èµ„æºæ—¶è‡ªåŠ¨è°ƒç”¨
- `DecrementPetEssence()` - å‡å°‘ç²¾åæ—¶è‡ªåŠ¨è°ƒç”¨

---

## Redisé”®ç»“æ„

```
è£…å¤‡æ—¶é—´æˆ³:  user:{userID}:equipment:last_operation_time = {unix_timestamp}
çµå® æ—¶é—´æˆ³:  user:{userID}:pet:last_operation_time = {unix_timestamp}
```

**ä¾‹å­** (userID=123):
```
user:123:equipment:last_operation_time = 1703158800
user:123:pet:last_operation_time = 1703158805
```

---

## å®šæœŸåŒæ­¥æµç¨‹

### æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

```
1. æ‰«æRedisè£…å¤‡/çµå® ç¼“å­˜é”®
2. å¯¹æ¯ä¸ªç”¨æˆ·æ£€æŸ¥: ShouldSync(userID, timeout=5ç§’) ?
3. âœ… True  â†’ åŒæ­¥åˆ°æ•°æ®åº“
   âŒ False â†’ è·³è¿‡ (æœ€è¿‘æœ‰æ“ä½œ)
4. è¾“å‡ºæ—¥å¿—: total/success/failed/skipped
```

### æ—¥å¿—ç¤ºä¾‹

```
[INFO] å¼€å§‹åŒæ­¥è£…å¤‡èµ„æº count=245
[INFO] è£…å¤‡èµ„æºåŒæ­¥å®Œæˆ total=245 success=120 failed=3 skipped=122
```

---

## è°ƒæ•´é…ç½®

### ä¿®æ”¹è¶…æ—¶æ—¶é—´

**æ–‡ä»¶**: `internal/tasks/sync_equipment_resources.go`

```go
const syncTimeoutSeconds int64 = 5  // æ”¹ä¸ºéœ€è¦çš„ç§’æ•°

// å¸¸è§å€¼:
// 3ç§’   - æ›´æ¿€è¿›åŒæ­¥,æ•°æ®æ›´æ–°é²œ,DBå‹åŠ›å¢åŠ 
// 5ç§’   - å¹³è¡¡æ–¹æ¡ˆ (æ¨è)
// 10ç§’  - ä¿å®ˆåŒæ­¥,DBå‹åŠ›æ›´ä½,æ•°æ®æ»åå¢åŠ 
```

### ä¿®æ”¹åŒæ­¥é—´éš”

**æ–‡ä»¶**: `cmd/server/main.go` ä¸­çš„ `tasks.go` åˆå§‹åŒ–

```go
StartEquipmentResourcesSyncTask(5 * time.Minute)  // æ”¹ä¸ºéœ€è¦çš„é—´éš”
StartPetResourcesSyncTask(5 * time.Minute)

// å¸¸è§å€¼:
// 3 * time.Minute   - æ›´é¢‘ç¹æ‰«æ
// 5 * time.Minute   - å¹³è¡¡ (æ¨è)
// 10 * time.Minute  - é™ä½æ‰«æé¢‘ç‡
```

---

## æ•°æ®æµå‘å›¾

```
ç©å®¶æ“ä½œ (å¼ºåŒ–/å‡çº§/å‡æ˜Ÿ)
   â†“
Handlerå¤„ç† (equipment_handler.go / pet_handler.go)
   â†“
ä¿®æ”¹Redisç¼“å­˜
   â”œâ”€ å‡å°‘å¼ºåŒ–çŸ³: DecrementReinforceStones()
   â”‚  â”œâ”€ ä¿®æ”¹ç¼“å­˜å€¼
   â”‚  â””â”€ âœ… è‡ªåŠ¨è°ƒç”¨ UpdateEquipmentLastOperationTime()
   â””â”€ å‡å°‘ç²¾å: DecrementPetEssence()
      â”œâ”€ ä¿®æ”¹ç¼“å­˜å€¼
      â””â”€ âœ… è‡ªåŠ¨è°ƒç”¨ UpdatePetLastOperationTime()
   â†“
è¿”å›æˆåŠŸç»™å®¢æˆ·ç«¯ (æ•°æ®è¿˜åœ¨Redisä¸­)
   â†“
[åå°å®šæœŸåŒæ­¥ä»»åŠ¡ - æ¯5åˆ†é’Ÿ]
   â†“
æ‰«æRedisé”® â†’ æ£€æŸ¥æœ€åæ“ä½œæ—¶é—´ â†’ è¶…è¿‡5ç§’åˆ™åŒæ­¥åˆ°DB
   â†“
å†™å…¥æ•°æ®åº“ (Userè¡¨: reinforce_stones, refinement_stones, pet_essence)
```

---

## ç¼“å­˜ä¸€è‡´æ€§ä¿éšœ

### ä¸‰å±‚é˜²æŠ¤

1. **TTLè‡ªåŠ¨è¿‡æœŸ** (20ç§’)
   - å¦‚æœ5ç§’åæ²¡æœ‰åŒæ­¥,ç¼“å­˜ä¼šè‡ªåŠ¨è¿‡æœŸ
   - ç¡®ä¿Redisä¸ä¼šæ— é™å †ç§¯æ•°æ®

2. **ç™»å‡º/å¿ƒè·³è¶…æ—¶å¼ºåˆ¶åŒæ­¥**
   - ç©å®¶ç™»å‡ºæˆ–å¿ƒè·³æ–­å¼€æ—¶
   - ç«‹å³åŒæ­¥æ‰€æœ‰ç¼“å­˜åˆ°DB,ä¸å—5ç§’é™åˆ¶
   - æ¸…ç†Redisæ—¶é—´æˆ³é”®

3. **åå°å®šæœŸåŒæ­¥** (5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡)
   - æŠ“ä½"åƒµå°¸"ç©å®¶(æ‰çº¿ä½†ç¼“å­˜æœªæ¸…ç†)
   - 5ç§’è§„åˆ™ç¡®ä¿ä¸é¢‘ç¹æ‰“æ‰°æ´»è·ƒç©å®¶

### æœ€åæƒ…å†µä¸‹æ•°æ®å®‰å…¨

```
ç©å®¶å¼ºåŒ–è£…å¤‡ â†’ æ•°æ®å­˜Redis â†’ ç©å®¶æ‰çº¿
â””â”€ 20ç§’å†…: TTLè¿‡æœŸæˆ–åŒæ­¥å®Œæˆ âœ…
â””â”€ æœ€åå»¶è¿Ÿ: <20ç§’ âœ…
```

---

## å¸¸è§é—®é¢˜

### Q: 5ç§’å¤ªé•¿/å¤ªçŸ­æ€ä¹ˆåŠ?

**A**: æ ¹æ®éœ€æ±‚è°ƒæ•´:
```go
// æ‰“å¼€ sync_equipment_resources.go
const syncTimeoutSeconds int64 = 5  // â† æ”¹è¿™ä¸ªå€¼

// ç„¶åé‡æ–°ç¼–è¯‘éƒ¨ç½²
```

### Q: ä¸ºä»€ä¹ˆç”¨æˆ·Açš„æ•°æ®æ²¡æœ‰åŒæ­¥?

**A**: æ£€æŸ¥:
1. ç”¨æˆ·åœ¨æœ€è¿‘5ç§’æœ‰æ“ä½œ? â†’ æ­£å¸¸,ç­‰å¾…5ç§’
2. ç”¨æˆ·çš„æ—¶é—´æˆ³é”®å­˜åœ¨? â†’ æ£€æŸ¥Redis: `KEYS user:*:equipment:last_operation_time`
3. ç”¨æˆ·ç¦»çº¿è¶…è¿‡20ç§’? â†’ åº”è¯¥å·²è¢«TTLæ¸…ç†,æ£€æŸ¥æ—¥å¿—

### Q: æ—¥å¿—é‡Œskippedå¾ˆå¤šæ˜¯å¦æ­£å¸¸?

**A**: æ˜¯çš„!æ­£å¸¸ç°è±¡:
```
è£…å¤‡èµ„æºåŒæ­¥å®Œæˆ total=245 success=120 failed=3 skipped=122
â†‘ 122ä¸ªç”¨æˆ·æœ€è¿‘5ç§’æœ‰æ“ä½œ,æ­£ç¡®åœ°è¢«è·³è¿‡äº†
```

é«˜skippedæ¯”ä¾‹è¯´æ˜ç³»ç»Ÿå·¥ä½œæ­£å¸¸,æ´»è·ƒç©å®¶å¤šã€‚

### Q: èƒ½å¦æ”¹æˆ1ç§’?

**A**: ä¸å»ºè®®:
- 1ç§’å¤ªçŸ­,åŒæ­¥ä¼šéå¸¸é¢‘ç¹
- æ•°æ®åº“å‹åŠ›åè€Œå¢åŠ 
- å»ºè®®æœ€å°å€¼ä¸º3ç§’

---

## æ€§èƒ½å¯¹æ ‡

| åœºæ™¯ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹è¿› |
|-----|-------|-------|------|
| 1000ç©å®¶åœ¨çº¿ | 12,000æ¬¡DBå†™/å°æ—¶ | 5,000æ¬¡DBå†™/å°æ—¶ | â†“60% |
| å¹³å‡åŒæ­¥å»¶è¿Ÿ | 2.5åˆ†é’Ÿ | <10ç§’ | â†“ 15å€ |
| æ•°æ®ä¸¢å¤±é£é™© | <20ç§’ | <20ç§’ | ç›¸åŒ |
| CPUå ç”¨ | åŸºå‡† | åŸºå‡†-20% | â†“20% |

---

## éƒ¨ç½²æ£€æŸ¥

- [x] ä¿®æ”¹ `redis/equipment.go` - æ·»åŠ æ—¶é—´æˆ³å‡½æ•°
- [x] ä¿®æ”¹ `redis/pet.go` - æ·»åŠ æ—¶é—´æˆ³å‡½æ•°
- [x] ä¿®æ”¹ `tasks/sync_equipment_resources.go` - ä¼˜åŒ–åŒæ­¥é€»è¾‘
- [x] ç¼–è¯‘éªŒè¯ - `go build ./cmd/server` âœ…
- [ ] è¿è¡ŒéªŒè¯ - å¯åŠ¨æœåŠ¡å™¨è§‚å¯Ÿæ—¥å¿—
- [ ] ç°åº¦å‘å¸ƒ - å…ˆå‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒ

---

## å…³é”®æ–‡ä»¶ä¸€è§ˆ

```
src/
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ redis/
â”‚   â”‚   â”œâ”€â”€ equipment.go          â† è£…å¤‡æ—¶é—´æˆ³ç®¡ç†
â”‚   â”‚   â””â”€â”€ pet.go                â† çµå® æ—¶é—´æˆ³ç®¡ç†
â”‚   â””â”€â”€ tasks/
â”‚       â””â”€â”€ sync_equipment_resources.go  â† å®šæœŸåŒæ­¥ä»»åŠ¡
â”‚
â””â”€â”€ cmd/server/
    â””â”€â”€ main.go                   â† å¯åŠ¨ä»»åŠ¡å…¥å£
```

---

## å¿«é€Ÿæ•…éšœæ’æŸ¥

**æ—¥å¿—æ²¡æœ‰skippedè®¡æ•°?**
â†’ å¯èƒ½æ˜¯æ—§ç‰ˆæœ¬,æ£€æŸ¥æ˜¯å¦å·²æ›´æ–°æ‰€æœ‰æ–‡ä»¶

**æ—¶é—´æˆ³é”®ä¸ºç©º?**
â†’ æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº† `UpdateEquipmentLastOperationTime()`

**DBæ•°æ®æ²¡æœ‰æ›´æ–°?**
â†’ æ£€æŸ¥Redisä¸­æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®,æ˜¯å¦è¶…è¿‡5ç§’

---

## æ€»ç»“

âœ… **æ–°ç­–ç•¥çš„ä¼˜åŠ¿**:
- è‡ªåŠ¨è®°å½•æ“ä½œæ—¶é—´
- æ™ºèƒ½è·³è¿‡æ´»è·ƒç©å®¶
- æ•°æ®åº“å‹åŠ›â†“40-60%
- æ— éœ€æ‰‹åŠ¨ç»´æŠ¤

âœ… **é£é™©ç­‰çº§**: ğŸŸ¢ **ä½** (æœ‰ä¸‰å±‚ä¿æŠ¤)

âœ… **æ¨èè¡ŒåŠ¨**: éƒ¨ç½²ä¸Šçº¿ (æ— éœ€å›æ»šé£é™©)

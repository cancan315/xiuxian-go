# 灵宠系统需求文档

## 1. 系统概述

灵宠系统是游戏中的核心玩法之一，允许玩家抽取、培养、出战各种灵宠来增强角色实力。灵宠不仅具有独特的外观和描述，还能为玩家提供强大的属性加成。灵宠系统已改造为完全使用后端API，前端只负责UI展示，所有状态管理均由后端负责。

## 2. 灵宠品质体系

游戏中灵宠按照品质分为6个等级：
- 仙兽(mythic)
- 瑞兽(legendary)
- 上古异兽(epic)
- 灵兽(rare)
- 妖兽(uncommon)
- 凡兽(common)

每种品质都有对应的名称、颜色和属性加成系数。

## 3. 灵宠获取方式

### 3.1 抽卡系统
玩家可以通过抽卡系统获得灵宠，不同品质的灵宠有不同的抽取概率：
- 仙兽：0.1%
- 瑞兽：0.3%
- 上古异兽：1.6%
- 灵兽：3%
- 妖兽：15%
- 凡兽：80%

### 3.2 灵宠属性
每只灵宠都具有以下基础属性：
- 唯一标识符(id)
- 名称(name)
- 类型(type='pet')
- 品质(rarity)
- 等级(level，默认为1)
- 星级(star，默认为0)
- 经验值(experience)
- 描述(description)
- 战斗属性(combatAttributes)

## 4. 灵宠核心功能

### 4.1 出战/召回
- 玩家可以同时出战一只灵宠
- 出战的灵宠会为玩家提供属性加成
- 召回灵宠会移除其提供的属性加成
- 出战/召回操作完全由后端处理，前端只负责发起请求和展示结果

### 4.2 升级
- 使用灵宠精华可以提升灵宠等级
- 升级会增强灵宠的各项战斗属性
- 每级消耗一定数量的灵宠精华
- 升级操作完全由后端处理，前端只负责发起请求和展示结果

### 4.3 升星
- 使用相同品质的灵宠作为材料可以提升目标灵宠星级
- 相同名字的灵宠升星成功率为100%
- 不同名字的灵宠升星成功率为30%
- 升星成功会增强灵宠的各项战斗属性
- 升星操作完全由后端处理，前端只负责发起请求和展示结果

### 4.4 批量放生
- 玩家可以批量放生未出战的灵宠
- 放生后可以获得经验值和强化石奖励
- 可以选择特定品质进行批量放生
- 放生操作完全由后端处理，前端只负责发起请求

## 5. 灵宠属性系统

### 5.1 基础属性
- 攻击力(attack)
- 生命值(health)
- 防御力(defense)
- 速度(speed)

### 5.2 战斗属性
- 暴击率(critRate)
- 连击率(comboRate)
- 反击率(counterRate)
- 眩晕率(stunRate)
- 闪避率(dodgeRate)
- 吸血率(vampireRate)

### 5.3 战斗抗性
- 抗暴击(critResist)
- 抗连击(comboResist)
- 抗反击(counterResist)
- 抗眩晕(stunResist)
- 抗闪避(dodgeResist)
- 抗吸血(vampireResist)

### 5.4 特殊属性
- 强化治疗(healBoost)
- 强化爆伤(critDamageBoost)
- 弱化爆伤(critDamageReduce)
- 最终增伤(finalDamageBoost)
- 最终减伤(finalDamageReduce)
- 战斗属性提升(combatBoost)
- 战斗抗性提升(resistanceBoost)

### 5.5 属性加成管理
- 所有灵宠属性加成都由后端计算和管理
- 前端不再维护属性加成状态，只展示后端提供的最终属性值
- 出战时后端自动计算并应用属性加成到玩家数据
- 召回时后端自动移除相应属性加成

## 6. 后端数据存储

### 6.1 数据模型
灵宠数据存储在Pets表中，主要字段包括：
- id: UUID类型，灵宠唯一标识符
- userId: 关联的用户ID
- petId: 灵宠类型ID
- name: 灵宠名称
- type: 实体类型，默认为'pet'
- rarity: 稀有度等级
- level: 等级，默认为1
- star: 星级，默认为0
- experience: 当前经验值
- maxExperience: 升级所需的最大经验值
- quality: 品质属性，可能包含颜色、前缀等信息
- combatAttributes: 战斗属性，存储JSON格式的属性值
- isActive: 是否为活跃状态，决定灵宠是否被玩家使用
- power: 力量值，影响灵宠的战斗力
- upgradeItems: 升级所需物品数量
- description: 灵宠描述信息

### 6.2 API接口
- GET `/api/player/data`: 获取玩家完整数据，包括灵宠信息
- POST `/api/player/data`: 增量更新玩家数据

### 6.3 新增灵宠管理API接口

#### 出战灵宠
- 接口地址：POST `/api/player/pets/:id/deploy`
- 请求参数：灵宠ID
- 返回数据：操作结果
- 功能说明：将指定灵宠标记为出战状态，并计算应用其属性加成到玩家数据

#### 召回灵宠
- 接口地址：POST `/api/player/pets/:id/recall`
- 请求参数：灵宠ID
- 返回数据：操作结果
- 功能说明：将指定灵宠标记为召回状态，并移除其属性加成

#### 升级灵宠
- 接口地址：POST `/api/player/pets/:id/upgrade`
- 请求参数：
  - id: 灵宠ID
  - essenceCount: 消耗的灵宠精华数量
- 返回数据：升级结果及更新后的灵宠信息

#### 升星灵宠
- 接口地址：POST `/api/player/pets/:id/evolve`
- 请求参数：
  - id: 目标灵宠ID
  - foodPetId: 作为材料的灵宠ID
- 返回数据：升星结果及更新后的灵宠信息

#### 批量放生灵宠
- 接口地址：POST `/api/player/pets/batch-release`
- 请求参数：
  - rarity: 灵宠品质过滤（可选）
- 返回数据：放生结果及获得的资源

## 7. 前端实现

### 7.1 状态管理
使用Pinia进行状态管理，主要包括以下store：
- pets.js: 灵宠相关状态（仅用于UI展示）
- playerInfo.js: 玩家信息，包括当前出战的灵宠(activePet)
- combat.js: 战斗属性，包括基础属性、战斗属性、战斗抗性和特殊属性

### 7.2 核心功能组件
- Gacha.vue: 抽卡界面，用于获取灵宠
- Inventory.vue: 背包界面，用于管理灵宠（出战/召回、升级、升星、放生等）

### 7.3 灵宠操作方法
所有灵宠操作方法均已改造为调用后端API：
- deployPet: 出战灵宠（调用后端API）
- recallPet: 召回灵宠（调用后端API）
- upgradePet: 升级灵宠（调用后端API）
- evolvePet: 升星灵宠（调用后端API）
- batchReleasePets: 批量放生灵宠（调用后端API）

### 7.4 前端改造说明
- 移除了前端的灵宠状态管理逻辑
- 所有灵宠操作均通过API服务与后端通信
- 前端仅负责UI展示和用户交互
- 前端不再进行属性加成计算，直接显示后端计算好的属性值

## 8. 属性加成计算规则

灵宠属性加成根据品质基础加成、星级加成、等级加成和境界加成四部分计算：
- 品质基础加成：神品15%、仙品12%、玄品9%、灵品6%、凡品3%
- 星级加成：神品每星+2%，其他品质每星+1%
- 等级加成：每级提供基础加成的0.1倍
- 境界加成：每5星为1境界，每个境界提供基础加成的0.5倍

### 8.1 加成计算说明
- 所有属性加成计算均由后端完成
- 前端不参与任何属性加成计算逻辑
- 出战时后端自动将属性加成应用到玩家的baseAttributes、combatAttributes、combatResistance和specialAttributes中
- 召回时后端自动从玩家属性中移除对应加成

## 9. 注意事项

1. 所有状态管理均由后端负责，前端不再需要检查属性加成的应用状态
2. 灵宠精华等资源需要统一管理，确保数据一致性
3. 玩家每次获取数据时，得到的已经是包含了灵宠属性加成的最终属性值
# 秘境功能设计文档

## 功能概述

秘境是一个**类Roguelike的动态战斗系统**，玩家通过选择增益效果来提升属性，逐层向上闯关。系统采用**前端客户端计算 + 本地Web Worker**架构，完全在前端进行游戏逻辑处理。

---

## 核心架构

```
Dungeon.vue (主界面)
    ├─ 难度选择 (4个难度)
    ├─ 增益选择界面 (Roguelike风格)
    │   └─ dungeon.js (增益配置与选项生成)
    ├─ 战斗界面 (实时对战)
    │   └─ combat.js (战斗系统)
    │       └─ Web Worker (exploration.js - 后台计算)
    └─ 战斗统计
```

---

## 模块详解

### 1. **Dungeon.vue** - 主界面视图

#### 页面布局
```
┌─ 秘境探索 ─────────────────────────┐
│  [难度选择] [开始探索按钮]            │
├────────────────────────────────────┤
│ 当前层数: 1                          │
├────────────────────────────────────┤
│ ┌─ 选择增益 ───────────────────────┐│
│ │ [刷新增益(3)] 按钮                 ││
│ │ ┌─卡1──┐ ┌─卡2──┐ ┌─卡3──┐      ││
│ │ │增益  │ │增益  │ │增益  │      ││
│ │ │描述  │ │描述  │ │描述  │      ││
│ │ │品质  │ │品质  │ │品质  │      ││
│ │ └──────┘ └──────┘ └──────┘      ││
│ └────────────────────────────────┘│
├────────────────────────────────────┤
│ ┌─ 战斗界面 ───────────────────────┐│
│ │ 第1/10回合                        ││
│ │ ┌──玩家──┐      ┌──敌人──┐       ││
│ │ │ 名字   │      │ 名字   │       ││
│ │ │ 头像   │      │ 头像   │       ││
│ │ │ 血条   │      │ 血条   │       ││
│ │ └────────┘      └────────┘       ││
│ │                                  ││
│ │ ┌─ 战斗日志 ──────────────────┐ ││
│ │ │ 回合1: 玩家攻击敌人 ...      │ ││
│ │ │ 回合2: 敌人反击 ...          │ ││
│ │ └──────────────────────────────┘ ││
│ └────────────────────────────────┘│
└────────────────────────────────────┘
```

#### 关键数据结构

**难度选项**
```javascript
const dungeonOptions = [
  { label: '凡界', value: 'easy' },
  { label: '小世界', value: 'normal' },
  { label: '灵界', value: 'hard' },
  { label: '仙界', value: 'expert' }
]
```

**秘境状态**
```javascript
const dungeonState = {
  floor: 1,              // 当前层数
  inCombat: false,       // 是否在战斗中
  showingOptions: false, // 是否显示选项界面
  currentOptions: [],    // 当前增益选项 (3个)
  combatManager: null    // 战斗管理器实例
}
```

#### 核心方法

| 方法 | 功能 | 触发时机 |
|------|------|---------|
| `startDungeon()` | 初始化秘境 (floor=1, 显示选项) | 点击开始探索 |
| `generateOptions()` | 生成3个随机增益选项 | 开始秘境、刷新选项 |
| `selectOption(option)` | 选择增益、应用效果、进入战斗 | 点击增益卡 |
| `handleRefreshOptions()` | 刷新选项 (最多3次) | 点击刷新按钮 |
| `playerStats` | 计算玩家总属性 (基础+装备+灵宠) | 每次选择 |
| `enemyStats` | 计算敌人属性 (基于层数+难度) | 战斗开始 |

---

### 2. **dungeon.js** - 增益系统配置

#### 难度修饰符
```javascript
const difficultyModifiers = {
  easy:   { healthMod: 0.8,  damageMod: 0.8,  rewardMod: 0.8  },  // 凡界
  normal: { healthMod: 1.0,  damageMod: 1.0,  rewardMod: 1.0  },  // 小世界
  hard:   { healthMod: 1.2,  damageMod: 1.2,  rewardMod: 1.5  },  // 灵界
  expert: { healthMod: 1.5,  damageMod: 1.5,  rewardMod: 2.0  }   // 仙界
}
```

#### 增益选项池 (roguelikeOptions)

**普通品质 (common) - 8个**
| 增益ID | 名字 | 效果描述 | 机制 |
|--------|------|--------|------|
| heal | 气血增加 | 增加10%血量 | health * 1.1 |
| small_buff | 小幅强化 | 增加10%伤害 | finalDamageBoost += 0.1 |
| defense_boost | 铁壁 | 提升20%防御力 | defense * 1.2 |
| speed_boost | 疾风 | 提升15%速度 | speed * 1.15 |
| crit_boost | 会心 | 提升15%暴击率 | critRate += 0.15 |
| dodge_boost | 轻身 | 提升15%闪避率 | dodgeRate += 0.15 |
| vampire_boost | 吸血 | 提升10%吸血率 | vampireRate += 0.1 |
| combat_boost | 战意 | 提升10%战斗属性 | combatBoost += 0.1 |

**稀有品质 (rare) - 6个**
| 增益ID | 名字 | 效果描述 |
|--------|------|--------|
| defense_master | 防御大师 | 防御力提升10% |
| crit_mastery | 会心精通 | 暴击率+10%, 爆伤+20% |
| dodge_master | 无影 | 闪避率提升10% |
| combo_master | 连击精通 | 连击率提升10% |
| vampire_master | 血魔 | 吸血率提升5% |
| stun_master | 震慑 | 眩晕率提升5% |

**史诗品质 (epic) - 6个**
| 增益ID | 名字 | 效果描述 |
|--------|------|--------|
| ultimate_power | 极限突破 | 所有战斗属性提升50% |
| divine_protection | 天道庇护 | 最终减伤提升30% |
| combat_master | 战斗大师 | 战斗属性+25%, 抗性+25% |
| immortal_body | 不朽之躯 | 生命上限+100%, 减伤+20% |
| celestial_might | 天人合一 | 战斗属性+40%, 血量+50% |
| battle_sage_supreme | 战圣至尊 | 暴击率+40%, 爆伤+80%, 伤害+20% |

#### 选项生成算法

**概率体系** (getRandomOptions函数)
```javascript
// 基础概率
let commonChance = 0.70   // 普通
let rareChance = 0.25     // 稀有
let epicChance = 0.05     // 史诗

// 每5层调整 (floor % 5 === 0)
commonChance = 0.50
rareChance = 0.35
epicChance = 0.15

// 每10层调整 (floor % 10 === 0)
commonChance = 0.50
rareChance = 0.30
epicChance = 0.20

// 生成3个不重复的增益选项
```

---

### 3. **combat.js** - 战斗系统核心

#### 战斗属性定义 (CombatStats类)

**基础属性**
```javascript
health       // 生命值
maxHealth    // 最大生命值
damage       // 伤害 (攻击力)
defense      // 防御力
speed        // 速度 (决定先手)
```

**战斗属性 (百分比)**
```javascript
critRate      // 暴击率 (default: 5%)
comboRate     // 连击率 (default: 0%)
counterRate   // 反击率 (default: 0%)
stunRate      // 眩晕率 (default: 0%)
dodgeRate     // 闪避率 (default: 5%)
vampireRate   // 吸血率 (default: 0%)
```

**战斗抗性 (百分比, 抵消敌方属性)**
```javascript
critResist       // 抗暴击
comboResist      // 抗连击
counterResist    // 抗反击
stunResist       // 抗眩晕
dodgeResist      // 抗闪避
vampireResist    // 抗吸血
```

**特殊属性 (百分比)**
```javascript
healBoost              // 强化治疗
critDamageBoost        // 强化爆伤 (default: 50%)
critDamageReduce       // 弱化爆伤
finalDamageBoost       // 最终增伤
finalDamageReduce      // 最终减伤
combatBoost            // 战斗属性提升 (乘数)
resistanceBoost        // 战斗抗性提升 (乘数)
```

#### 伤害计算流程

**计算方式**
```
原始伤害 = 基础伤害 * (1 + combatBoost)

暴击判定:
  - 有效暴击率 = max(0, min(0.8, 
      critRate * (1 + combatBoost) - 目标.critResist * (1 + 目标.resistanceBoost)
    ))
  - 如果触发: 伤害 *= 1.5 + critDamageBoost

连击判定:
  - 有效连击率 = max(0, min(0.8, comboRate * (1 + combatBoost) - 目标.comboResist))
  - 如果触发: 伤害 *= 1.3

眩晕判定:
  - 有效眩晕率 = max(0, min(0.8, stunRate * (1 + combatBoost) - 目标.stunResist))
  - 如果触发: 目标无法行动

吸血判定:
  - 有效吸血率 = max(0, min(0.8, vampireRate * (1 + combatBoost) - 目标.vampireResist))
  - 如果触发: 攻击者回复 伤害 * 30%

最终伤害 = 伤害 * (1 + finalDamageBoost)
```

**伤害减免计算**
```
受到伤害 = 伤害 * 100 / (100 + defense)

如果是暴击: 伤害 *= (1 - critDamageReduce)
如果有抗性: 伤害 *= (1 - finalDamageReduce)
最终受伤 = max(0, 受到伤害)
```

#### 战斗流程 (CombatManager类)

**一回合战斗执行顺序**
```
1. 比较双方速度 → 确定先手和后手
2. 先手攻击:
   - 计算伤害 (暴击、连击、吸血、眩晕)
   - 后手承受伤害
   - 记录日志
   - 检查是否死亡 → 战斗结束
3. 后手攻击 (如果未被眩晕):
   - 计算伤害
   - 先手承受伤害
   - 如果触发反击: 日志标记反击
   - 记录日志
   - 检查是否死亡 → 战斗结束
4. 检查最大回合数 (100回合) → 战斗失败
```

**战斗状态机**
```
READY → IN_PROGRESS → (VICTORY | DEFEAT | 超出回合数)
```

#### 敌人生成 (generateEnemy函数)

**敌人属性计算**
```javascript
baseHealth = 100 + difficulty * level * 200
baseDamage = 8 + difficulty * level * 2
baseDefense = 3 + difficulty * level * 2
baseSpeed = 5 + difficulty * level * 2

// 战斗属性
critRate = 0.05 + difficulty * level * 0.02
comboRate = 0.03 + difficulty * level * 0.02
stunRate = 0.02 + difficulty * level * 0.01
dodgeRate = 0.05 + difficulty * level * 0.02
vampireRate = 0.02 + difficulty * level * 0.01

// 特殊属性
healBoost = 0.05 + difficulty * level * 0.02
critDamageBoost = 0.2 + difficulty * level * 0.1
finalDamageBoost = 0.05 + difficulty * level * 0.02
combatBoost = 0.03 + difficulty * level * 0.02
```

**敌人类型调整**
- **精英 (ELITE)**: 所有百分比属性 × 1.3 (上限80%), 数值属性 × 1.5
- **Boss (BOSS)**: 所有百分比属性 × 1.5 (上限90%), 数值属性 × 2

**敌人名称池**
```javascript
普通: ['野狼', '山猪', '毒蛇', '黑熊', '猛虎', '恶狼', '巨蟒', '狂狮']
精英: ['赤焰虎', '玄冰蟒', '紫电豹', '金刚猿', '幽冥狼', '碧水蛟', '雷霆鹰', '烈风豹']
Boss: ['九尾天狐', '万年龙蟒', '太古神虎', '玄天冰凤', '幽冥魔龙', '混沌巨兽', '远古天蟒', '不死火凤']
```

---

### 4. **dungeonBuffs.js** - 增益管理器 (辅助)

#### 功能说明

```javascript
dungeonBuffs = {
  // 存储当前应用的增益
  activeBuffs: [
    { id, name, effect }
  ],
  
  // 应用增益效果
  apply(player, option) {
    // 添加到列表并执行效果函数
  },
  
  // 清除所有增益 (重置属性)
  clear(player) {
    // 重置玩家属性为基础值
  },
  
  // 获取当前活跃增益列表
  getActiveBuffs() {
    return this.activeBuffs
  }
}
```

**用途**: 管理已应用的增益效果，方便查看和清除。

---

## 游戏流程

### 完整流程图

```
开始游戏
   ↓
选择难度 (凡界/小世界/灵界/仙界)
   ↓
[第一层]
   ↓
显示3个增益选项 (普通/稀有/史诗)
   ↓
玩家选择或刷新 (最多3次)
   ↓
应用增益效果到玩家属性
   ↓
层数+1, 显示当前层数
   ↓
生成敌人 (基于层数+难度+类型)
   ↓
进入战斗 (Web Worker计算)
   ↓
┌─ 战斗循环 ─────────────────┐
│ 1. 根据速度确定先手         │
│ 2. 先手攻击，计算所有效果   │
│ 3. 后手承受伤害             │
│ 4. 检查是否死亡             │
│ 5. 后手攻击 (如未眩晕)      │
│ 6. 先手承受伤害             │
│ 7. 回合数++                 │
│ 8. 如果 回合数 > 100: 失败  │
└────────────────────────────┘
   ↓
战斗结束
   ↓
┌─ 胜利分支              ┌─ 失败分支
│ 获得奖励               │ 统计失败次数
│ 统计击杀数             │ 秘境结束
│ 回到选项界面           │
│ 继续下一层             │
└────────────────────────┘
```

### 状态转换

```
1. 显示选项 → 选择增益 → 应用增益
2. 应用增益 → 进入战斗 → 战斗循环
3. 战斗循环 → 胜利 → 下一层 (goto 1)
4. 战斗循环 → 失败 → 秘境结束
5. 战斗循环 → 超出回合 → 秘境结束
```

---

## 数据统计

在 **statsStore** 中记录:

```javascript
dungeonTotalRuns      // 总运行次数
dungeonTotalKills     // 总击杀数
dungeonBossKills      // Boss击杀数
dungeonEliteKills     // 精英击杀数
dungeonDeathCount     // 死亡次数
dungeonTotalRewards   // 总获得奖励次数
dungeonDifficulty     // 当前难度
```

---

## 玩家属性体系

### 属性优先级计算

```
玩家总属性 = 基础属性 + 装备加成 + 灵宠加成 + 增益加成
```

**目前实现**
- ✅ 基础属性 (来自playerInfoStore.baseAttributes)
- ❌ 装备加成 (计为0，已废弃，由后端处理)
- ❌ 灵宠加成 (计为0，已移除，由后端处理)
- ✅ 增益加成 (dungeon.js中的effect函数)

---

## 前后端分工

### 当前架构 (纯前端)

| 功能 | 位置 | 技术 |
|------|------|------|
| 增益选择 | Dungeon.vue | Vue3 + Naive UI |
| 增益配置 | dungeon.js | JavaScript对象 |
| 战斗计算 | combat.js + Worker | Web Worker |
| 属性管理 | playerInfoStore | Pinia |
| 数据持久化 | persistenceStore | LocalStorage |

### 后端改造方向

未来可迁移至Go后端:
- [ ] 增益选项生成 (RNG种子同步)
- [ ] 战斗计算 (确保公平性)
- [ ] 敌人生成算法
- [ ] 伤害计算核心逻辑
- [ ] 掉落物品系统
- [ ] 成就系统

---

## 注意事项

### 已知问题

1. **敌人属性计算**: 使用 `statsStore.dungeonDifficulty` (数值)，应该转换为 difficultyModifiers对象
   ```javascript
   // 当前: 0.8 * playerStats.value.attack
   // 应该: difficultyModifiers[difficulty].damageMod * playerStats.value.attack
   ```

2. **Web Worker引用**: 使用 `exploration.js`，应该有专属的 `dungeon.js` Worker

3. **属性堆叠**: 多个增益可能导致属性数值过高，建议添加属性上限

4. **平衡性**: 史诗品质的增益过强 (极限突破: +50%), 可能导致秘境过于简单

### 改进建议

1. **难度分层**
   - 添加难度曲线，确保层数越高难度越大
   - 当前敌人属性没有随层数指数增长

2. **增益平衡**
   - 普通品质: 1-2%提升
   - 稀有品质: 5-10%提升
   - 史诗品质: 20-50%提升

3. **Roguelike深度**
   - 添加负面增益 (debuff)
   - 添加选择困难 (舍弃已有增益来获得更强增益)
   - 添加突发事件 (随机商人、BOSS提前出现)

4. **后端集成建议**
   - 秘境成绩保存至数据库
   - 最高楼层排行榜
   - 集中RNG逻辑，确保公平性

---

## 总结

秘境功能是一个**完整的Roguelike战斗系统**，具有：
- ✅ **4个难度等级** (动态调整敌人属性)
- ✅ **20个增益选项** (普通/稀有/史诗三品质)
- ✅ **完整战斗系统** (暴击/连击/吸血/眩晕/反击)
- ✅ **实时战斗动画** (血条/攻击特效/受伤动画)
- ✅ **战斗日志** (详细的战斗过程记录)
- ✅ **数据统计** (击杀数/死亡数/奖励统计)

核心特点是**在前端完全计算**，无需后端支持，适合轻量级部署。未来可逐步迁移至后端以增强安全性和公平性。
